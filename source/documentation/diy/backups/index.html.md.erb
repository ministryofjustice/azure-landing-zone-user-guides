---
title: Backups
last_reviewed_on: 2023-09-23
review_in: 6 months
weight: 3500
---

# ALZ Windows and Linux Virtual Machine Backup Facility

The ALZ patch repository [here](https://github.com/ministryofjustice/staff-infrastructure-alz-backup) contains Terraform code for backing up virtual machines. The Terraform code in this repository creates backup policies in a specified Recovery Services vault and associates them with existing VMs. Each VM can be in a different resource group, and each VM can have its own backup policy. The backup policies are created separately and can be reused for multiple VMs.

## Pre-requisites

This configuration is intended for managing backups for existing VMs. The VMs and the Recovery Services vault should already exist in Azure.

## Quick-Start

- Clone this repository and create a new branch.
- Make amendments to the relevant files.
- Open a PR against `main`.
- Wait for a member of the ALZ team to approve and deploy.

## Usage

The configuration uses several input variables to customize the backup policies and VMs. Users can specify the details of their VMs and backup policies in the auto.tfvars files:

- `backup-policies.auto.tfvars`: Contains `backup_policies`, a list of backup policies. Each item in the list is an object that specifies a backup policy.
- `vm-backup-config.auto.tfvars`: Contains `vms`, a map where each key is a VM name, and each value is an object containing the resource group name and the backup policy name for that VM.
- `vault_resource_group_name`: The name of the resource group where the Recovery Services vault and backup policies are located.
- `vault_name`: The name of the Recovery Services vault.

## Core Files

This repository includes:

- `variables.tf`: Declaration of variables used in the configuration.
- `data.tf`: Data blocks to fetch information about existing resources, such as the Recovery Services vault and VMs.
- `main.tf`: Resource blocks to create the backup policies and associate them with VMs.
- `versions.tf`: Provider configuration.

## Full Usage

### Configuration Files

There are two primary tfvars files:

#### Backup Configuration (`backup-policies.auto.tfvars`)

Defines the backup policies:

- `vault_resource_group_name`: Name of the resource group where the Recovery Services Vault resides.
- `vault_name`: Name of the Recovery Services Vault.
- `backup_policies`: A list of backup policies, with attributes like name, frequency, retention days, etc.

```plaintext
vault_resource_group_name = "rg-hub-core-001"
vault_name                = "rsv-hub-core-001"
backup_policies = [...]
